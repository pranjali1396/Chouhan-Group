/**
 * CRM Integration Script - Production Ready
 * For Chouhan Park View Website
 * 
 * Instructions:
 * 1. Update API_URL below with your backend URL
 * 2. Add this script to your website before </body> tag
 * 3. The script will automatically detect and handle form submissions
 */

(function() {
  'use strict';

  // ===== CONFIGURATION - UPDATE THIS =====
  const CONFIG = {
    // ⚠️ IMPORTANT: This is your BACKEND API URL, NOT your website URL!
    // 
    // For local testing (backend on your computer):
    API_URL: 'http://localhost:5000/api/v1/webhooks/lead',
    //
    // For production (after deploying backend to Railway/Render/etc):
    // API_URL: 'https://your-backend-api.railway.app/api/v1/webhooks/lead',
    // Replace 'your-backend-api.railway.app' with your actual deployed backend URL
    
    SOURCE_NAME: 'Chouhan Park View Website',
    DEBUG: true // Set to false in production
  };

  function log(msg, data) {
    if (CONFIG.DEBUG) console.log('[CRM]', msg, data || '');
  }

  function getUrlParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
  }

  function mapFormToLead(formData) {
    const name = formData.get('name') || formData.get('Name') || formData.get('customerName') || '';
    const email = formData.get('email') || formData.get('Email') || '';
    const phone = formData.get('phone') || formData.get('Phone') || formData.get('mobile') || '';
    const broker = formData.get('broker') || formData.get('Are you a broker?') || '';
    const source = formData.get('source') || formData.get('How did you hear about us?') || '';
    const homeType = formData.get('homeType') || formData.get('Home type interested in?') || '';
    const message = formData.get('message') || formData.get('Message') || '';

    const unitMap = {
      '1 Bedroom': 'Flat', '2 Bedroom': 'Flat', '3 Bedroom': 'Flat', '4 Bedroom': 'Flat',
      'Flat': 'Flat', 'Bungalow': 'Bungalow', 'Commercial': 'Commercial'
    };
    const interestedUnit = unitMap[homeType] || homeType || 'Flat';

    const enquiryMap = {
      'Google Search': 'Digital', 'Social Media': 'Digital', 'Newspaper': 'Digital',
      'Friend/Referral': 'Reference', 'Advertisement': 'Digital', 'Other': 'Digital'
    };
    const modeOfEnquiry = enquiryMap[source] || 'Digital';

    return {
      source: CONFIG.SOURCE_NAME,
      sourceUrl: window.location.origin + window.location.pathname,
      customerName: name.trim(),
      mobile: phone.trim(),
      email: email.trim(),
      city: 'Bhilai',
      interestedProject: 'Chouhan Park View',
      interestedUnit: interestedUnit,
      modeOfEnquiry: modeOfEnquiry,
      remarks: message.trim() || `Inquiry from ${CONFIG.SOURCE_NAME}. Source: ${source}. Home type: ${homeType}. Broker: ${broker}`,
      metadata: {
        utm_source: getUrlParam('utm_source'),
        utm_campaign: getUrlParam('utm_campaign'),
        page_url: window.location.href,
        referrer: document.referrer,
        is_broker: broker === 'Yes' || broker === 'yes',
        lead_source: source,
        home_type: homeType
      }
    };
  }

  async function sendToCRM(leadData) {
    try {
      log('Sending lead...', leadData);
      const response = await fetch(CONFIG.API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(leadData)
      });
      const result = await response.json();
      if (response.ok && result.success) {
        log('✅ Lead sent!', result.leadId);
        return { success: true, leadId: result.leadId };
      } else {
        log('❌ Error:', result.error);
        return { success: false, error: result.error };
      }
    } catch (error) {
      log('❌ Network error:', error);
      return { success: false, error: error.message };
    }
  }

  function init() {
    const forms = document.querySelectorAll('form');
    log(`Found ${forms.length} form(s)`);

    forms.forEach(form => {
      form.addEventListener('submit', async function(e) {
        const formData = new FormData(form);
        const hasContactFields = formData.has('name') || formData.has('phone') || formData.has('email') ||
                                 formData.has('Name') || formData.has('Phone') || formData.has('Email');

        if (hasContactFields) {
          log('Contact form detected');
          const leadData = mapFormToLead(formData);
          sendToCRM(leadData).then(result => {
            if (result.success) {
              log('Lead sent to CRM successfully');
            }
          }).catch(err => log('Error:', err));
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.sendLeadToCRM = function(formData) {
    const leadData = mapFormToLead(formData);
    return sendToCRM(leadData);
  };

})();

